<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LangGraphGo ËÅäÂ§©Â∫îÁî®</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/marked/11.1.1/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/mermaid/10.9.0/mermaid.min.js"></script>
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script src="https://cdn.bootcdn.net/ajax/libs/mathjax/3.2.2/es5/tex-svg.js" id="MathJax-script"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            display: flex;
            width: 80%;
            max-width: 60%;
            height: calc(100vh - 40px);
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        /* Responsive adjustments */
        @media (max-width: 1600px) {
            .container {
                width: 85%;
                max-width: 70%;
            }
        }

        @media (max-width: 1200px) {
            .container {
                width: 90%;
                max-width: 80%;
            }
        }

        @media (max-width: 1400px) {
            .sidebar {
                width: 240px;
            }
            .artifacts-sidebar {
                width: 340px;
            }
            .chat-area {
                min-width: 350px;
            }
        }

        @media (max-width: 1200px) {
            .sidebar {
                width: 220px;
            }
            .artifacts-sidebar {
                width: 320px;
            }
            .chat-area {
                min-width: 300px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                width: 100%;
                height: calc(100vh - 20px);
                border-radius: 10px;
            }
            .sidebar {
                width: 200px;
            }
            .artifacts-sidebar {
                width: 280px;
            }
            .chat-area {
                min-width: 250px;
            }
        }

        @media (max-width: 600px) {
            .sidebar {
                width: 60px; /* Always collapsed on mobile */
            }
            .sidebar.collapsed .sidebar-header,
            .sidebar.collapsed .sessions-list {
                display: none;
            }
            .artifacts-sidebar {
                width: 60px; /* Always collapsed on mobile */
            }
            .chat-area {
                min-width: 0;
            }
        }

        .sidebar {
            width: 260px;
            background: #f7f9fc;
            border-right: 1px solid #e1e8ed;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: width 0.3s ease;
        }

        .sidebar.collapsed {
            width: 60px;
        }

        .collapse-btn {
            position: absolute;
            right: -20px;
            top: 20px;
            width: 40px;
            height: 40px;
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            z-index: 10;
        }

        .collapse-btn:hover {
            background: #f0f3ff;
            transform: scale(1.1);
        }

        .sidebar.collapsed .collapse-btn svg {
            transform: rotate(180deg);
        }

        .sidebar-header {
            padding: 20px;
            background: white;
            border-bottom: 1px solid #e1e8ed;
        }

        .sidebar-header h2 {
            font-size: 18px;
            color: #2c3e50;
            margin-bottom: 15px;
            transition: opacity 0.3s;
        }

        .new-chat-btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s;
        }

        /* Hide sidebar content when collapsed */
        .sidebar.collapsed .sidebar-header,
        .sidebar.collapsed .sessions-list {
            opacity: 0;
            pointer-events: none;
            overflow: hidden;
        }

        /* Artifact placeholder button styles */
        .artifact-placeholder {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            margin: 15px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
            width: 100%;
            max-width: 400px;
        }

        .artifact-placeholder::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            border-radius: 10px;
        }

        .artifact-placeholder:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #5568d3 0%, #6a4c93 100%);
        }

        .artifact-placeholder:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }

        .artifact-placeholder-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .artifact-placeholder-text {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
            flex: 1;
        }

        .artifact-placeholder-label {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .artifact-placeholder-title {
            font-size: 14px;
            font-weight: 700;
        }

        .artifact-placeholder-arrow {
            margin-left: auto;
            font-size: 16px;
            transition: transform 0.3s ease;
        }

        .artifact-placeholder:hover .artifact-placeholder-arrow {
            transform: translateX(3px);
        }

        .new-chat-btn:hover {
            background: #5568d3;
        }

        .sessions-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .session-item {
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .session-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .session-item.active {
            border-color: #667eea;
            background: #f0f3ff;
        }

        .session-title {
            font-size: 14px;
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .session-meta {
            font-size: 12px;
            color: #7f8c8d;
        }

        .session-meta-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 4px;
        }

        .session-actions {
            display: flex;
            gap: 8px;
        }

        .session-action-btn {
            padding: 2px 6px;
            font-size: 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
            opacity: 0.8;
        }

        .delete-btn:hover {
            background: #c0392b;
            opacity: 1;
            transform: scale(1.05);
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 400px; /* Minimum width for chat area */
        }

        /* Artifacts Sidebar Styles */
        .artifacts-sidebar {
            width: 380px;
            background: #f7f9fc;
            border-left: 1px solid #e1e8ed;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: width 0.3s ease;
        }

        .artifacts-sidebar.collapsed {
            width: 60px;
        }

        .artifacts-collapse-btn {
            position: absolute;
            left: -20px;
            top: 20px;
            width: 40px;
            height: 40px;
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            z-index: 10;
        }

        .artifacts-collapse-btn:hover {
            background: #f0f3ff;
            transform: scale(1.1);
        }

        .artifacts-sidebar.collapsed .artifacts-collapse-btn svg {
            transform: rotate(180deg);
        }

        .artifacts-header {
            padding: 20px;
            background: white;
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .artifacts-header h2 {
            font-size: 18px;
            color: #2c3e50;
            margin: 0;
            transition: opacity 0.3s;
        }

        .artifacts-header .artifact-title {
            font-size: 16px;
            color: #667eea;
            font-weight: 600;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }

        .artifacts-header .artifact-type {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: #f7f9fc;
            border-radius: 50%;
            font-size: 20px;
            color: #667eea;
            margin-right: 15px;
        }

  
        @keyframes pulse-glow {
            0%, 100% {
                opacity: 0.8;
            }
            50% {
                opacity: 1;
            }
        }

        .artifacts-content {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            background: #fafbfc;
            min-height: 0;
        }

        .no-artifacts {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
        }

        /* Hide artifacts content when collapsed */
        .artifacts-sidebar.collapsed .artifacts-header,
        .artifacts-sidebar.collapsed .artifacts-content {
            opacity: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .chat-header {
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h1 {
            font-size: 24px;
            color: #2c3e50;
        }

        .status {
            font-size: 14px;
            color: #7f8c8d;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background: #fafbfc;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 18px;
            position: relative;
        }

        .message.user .message-content {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-content {
            background: white;
            color: #2c3e50;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .message-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #e1e8ed;
        }

        .copy-btn {
            cursor: pointer;
            font-size: 12px;
            color: #7f8c8d;
            padding: 4px 8px;
            border-radius: 5px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }

        .copy-btn:hover {
            background-color: #f0f3ff;
            color: #2c3e50;
        }

        .copy-btn span {
            margin-left: 5px;
        }

        /* Markdown Content Styling */
        .message-content h1,
        .message-content h2,
        .message-content h3 {
            margin-top: 20px;
            margin-bottom: 10px;
            border-bottom: 1px solid #e1e8ed;
            padding-bottom: 5px;
        }
        .message-content h1 { font-size: 1.8em; }
        .message-content h2 { font-size: 1.5em; }
        .message-content h3 { font-size: 1.2em; }

        .message-content p {
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .message-content ul,
        .message-content ol {
            padding-left: 25px;
            margin-bottom: 15px;
        }

        .message-content li {
            margin-bottom: 5px;
        }

        .message-content code {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            background: #f7f9fc;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .message-content pre {
            background: #f7f9fc;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            overflow-x: auto;
        }

        .message-content pre code {
            background: none;
            padding: 0;
        }

        .message-content blockquote {
            border-left: 4px solid #667eea;
            padding-left: 15px;
            margin: 15px 0;
            color: #555;
            background: #f9f9f9;
        }

        .message-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .message-content th,
        .message-content td {
            border: 1px solid #e1e8ed;
            padding: 10px;
            text-align: left;
        }
        .message-content th {
            background-color: #f7f9fc;
            font-weight: 600;
        }

        /* Mermaid diagram styling */
        .message-content .mermaid {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #e1e8ed;
            overflow-x: auto;
        }

        .message-content .mermaid svg {
            max-width: 100%;
            height: auto;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 8px;
        }

        .input-area {
            padding: 20px 30px;
            background: white;
            border-top: 1px solid #e1e8ed;
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #message-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e1e8ed;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        #message-input:focus {
            border-color: #667eea;
        }

        #send-btn {
            padding: 15px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s;
        }

        #send-btn:hover:not(:disabled) {
            background: #5568d3;
        }

        #send-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .welcome {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
        }

        .welcome h2 {
            font-size: 28px;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 15px 20px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #7f8c8d;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {

            0%,
            60%,
            100% {
                transform: translateY(0);
            }

            30% {
                transform: translateY(-10px);
            }
        }

        .error {
            color: #e74c3c;
            padding: 10px;
            margin: 10px 0;
            background: #fadbd8;
            border-radius: 8px;
        }

        /* Artifacts Styles */
        .artifact-card {
            background: #f8f9fa;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            margin: 15px 0;
            overflow: hidden;
        }

        .artifact-header {
            background: #667eea;
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .artifact-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .artifact-type {
            font-size: 11px;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 12px;
        }

        .artifact-actions {
            display: flex;
            gap: 10px;
        }

        .artifact-action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .artifact-action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .artifact-preview {
            padding: 15px;
            background: white;
            max-height: 200px;
            overflow-y: auto;
        }

        .artifact-preview pre {
            margin: 0;
            background: #f7f9fc;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.5;
        }

        /* Artifact display styles */
        .artifact-full {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e1e8ed;
            margin-bottom: 20px;
        }

        .artifact-full pre {
            margin: 0;
            padding: 15px;
            background: #f7f9fc;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 13px;
        }

        .artifact-full iframe {
            width: 100%;
            height: 400px;
            border: none;
            border-radius: 4px;
        }

        .artifact-full svg,
        .artifact-full img {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="collapse-btn" id="collapse-btn" onclick="toggleSidebar()">
                <svg id="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15,18 9,12 15,6"></polyline>
                </svg>
            </div>
            <div class="sidebar-header">
                <h2>ËÅäÂ§©‰ºöËØù</h2>
                <button class="new-chat-btn" onclick="createNewSession(false)">+ Êñ∞Âª∫ËÅäÂ§©</button>
            </div>
            <div class="sessions-list" id="sessions-list">
                <!-- Sessions will be loaded here -->
            </div>
        </div>

        <div class="chat-area">
            <div class="chat-header">
                <h1>LangGraphGo ËÅäÂ§©</h1>
                <div class="status" id="status">ÈÄâÊã©ÊàñÂàõÂª∫‰∏Ä‰∏™‰ºöËØù</div>
            </div>
            <div class="messages" id="messages">
                <div class="welcome">
                    <h2>üëã Ê¨¢Ëøé!</h2>
                    <p>ÂàõÂª∫‰∏Ä‰∏™Êñ∞‰ºöËØùÊàñÈÄâÊã©Áé∞Êúâ‰ºöËØùÂºÄÂßãËÅäÂ§©„ÄÇ</p>
                </div>
            </div>
            <div class="input-area">
                <div class="input-container">
                    <input type="text" id="message-input" placeholder="ËæìÂÖ•ÊÇ®ÁöÑÊ∂àÊÅØ..." disabled>
                    <button id="send-btn" onclick="sendMessage()" disabled>ÂèëÈÄÅ</button>
                </div>
            </div>
        </div>

        <div class="artifacts-sidebar" id="artifacts-sidebar">
            <div class="artifacts-collapse-btn" id="artifacts-collapse-btn" onclick="toggleArtifactsSidebar()">
                <svg id="artifacts-collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9,18 15,12 9,6"></polyline>
                </svg>
            </div>
            <div class="artifacts-header" id="artifacts-header">
                <h2 id="artifacts-title">Artifacts</h2>
            </div>
            <div class="artifacts-content" id="artifacts-content">
                <div class="no-artifacts">No artifacts in this session</div>
            </div>
        </div>
    </div>

    
    <script>
        mermaid.initialize({ startOnLoad: false, theme: 'neutral' });

        let currentSessionId = null;

        // Initialize artifacts sidebar as collapsed
        document.addEventListener('DOMContentLoaded', () => {
            const artifactsSidebar = document.getElementById('artifacts-sidebar');
            if (artifactsSidebar) {
                artifactsSidebar.classList.add('collapsed');
            }
        });
        let sidebarCollapsed = false;
        let artifacts = new Map(); // Store artifacts by ID
        let currentArtifactId = null; // Track currently displayed artifact

        // Load sessions on page load
        loadSessions();

        // Enable Enter key to send message
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        async function loadSessions() {
            try {
                const response = await fetch('/api/sessions');
                const sessions = await response.json();

                const sessionsList = document.getElementById('sessions-list');
                sessionsList.innerHTML = '';

                if (sessions.length === 0) {
                    // Auto-create first session if none exists
                    sessionsList.innerHTML = '<p style="padding: 20px; text-align: center; color: #7f8c8d;">Creating session...</p>';
                    await createNewSession(true);
                    return;
                }

                sessions.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));

                // Auto-select the most recent session if no current session is selected
                if (!currentSessionId && sessions.length > 0) {
                    selectSession(sessions[0].id);
                }

                sessions.forEach(session => {
                    const item = document.createElement('div');
                    item.className = 'session-item' + (session.id === currentSessionId ? ' active' : '');
                    item.setAttribute('data-session-id', session.id);
                    item.innerHTML = `
                        <div class="session-title">${session.title || 'Êñ∞‰ºöËØù'}</div>
                        <div class="session-meta-row">
                            <div class="session-meta">${session.message_count} Êù°Ê∂àÊÅØ ‚Ä¢ ${formatDate(session.updated_at)}</div>
                            <button class="session-action-btn delete-btn" onclick="deleteSession('${session.id}', event)">Âà†Èô§</button>
                        </div>
                    `;
                    item.onclick = () => selectSession(session.id);
                    sessionsList.appendChild(item);
                });
            } catch (error) {
                console.error('Failed to load sessions:', error);
            }
        }

        async function createNewSession(autoSelect = false) {
            try {
                const response = await fetch('/api/sessions/new', { method: 'POST' });
                const data = await response.json();

                if (autoSelect) {
                    // For auto-created sessions, directly select without reloading
                    currentSessionId = data.session_id;
                    document.getElementById('message-input').disabled = false;
                    document.getElementById('send-btn').disabled = false;
                    document.getElementById('status').textContent = '';
                    // Load history (will be empty for new session)
                    await loadHistory(data.session_id);
                } else {
                    // For manual clicks, reload the full session list
                    await loadSessions();
                    selectSession(data.session_id);
                }
            } catch (error) {
                console.error('Failed to create session:', error);
                alert('Failed to create new session');
            }
        }

        async function selectSession(sessionId) {
            // Clear and save current artifacts before switching
            clearArtifacts();

            currentSessionId = sessionId;
            document.getElementById('message-input').disabled = false;
            document.getElementById('send-btn').disabled = false;
            document.getElementById('status').textContent = ``;

            // Update UI
            document.querySelectorAll('.session-item').forEach(item => {
                item.classList.remove('active');
            });

            // Find and highlight the selected session
            const selectedItem = document.querySelector(`[data-session-id="${sessionId}"]`);
            if (selectedItem) {
                selectedItem.classList.add('active');
            }

            // Load history
            await loadHistory(sessionId);
        }

        async function loadHistory(sessionId) {
            try {
                const response = await fetch(`/api/sessions/${sessionId}/history`);
                const messages = await response.json();

                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = '';

                // Clear artifacts before loading history
                artifacts.clear();

                for (const msg of messages) {
                    await addMessageToUI(msg.role, msg.content, msg.timestamp);
                }

                scrollToBottom();
            } catch (error) {
                console.error('Failed to load history:', error);
            }
        }

        async function sendMessage() {
            if (!currentSessionId) return;

            const input = document.getElementById('message-input');
            const message = input.value.trim();
            if (!message) return;

            // Disable input
            input.disabled = true;
            document.getElementById('send-btn').disabled = true;

            // Add user message to UI
            await addMessageToUI('user', message, new Date());
            input.value = '';

            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.innerHTML = `
                <div class="message-content typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            document.getElementById('messages').appendChild(typingDiv);
            scrollToBottom();

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        message: message
                    })
                });

                const data = await response.json();

                // Remove typing indicator
                typingDiv.remove();

                // Add assistant response
                await addMessageToUI('assistant', data.response, new Date());

                // Reload sessions to update message count
                loadSessions();
            } catch (error) {
                console.error('Failed to send message:', error);
                typingDiv.remove();
                addErrorMessage('Failed to get response. Please try again.');
            } finally {
                input.disabled = false;
                document.getElementById('send-btn').disabled = false;
                input.focus();
            }
        }

        async function addMessageToUI(role, content, timestamp) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const time = new Date(timestamp).toLocaleTimeString();
            let processedContent = '';
            let extractedArtifacts = [];

            if (role === 'assistant') {
                // First extract artifacts from content
                const result = extractArtifacts(content);
                extractedArtifacts = result.artifacts;

                console.log('Extracted artifacts:', extractedArtifacts); // Debug log
                console.log('Current session ID:', currentSessionId); // Debug log

                // Store artifacts
                extractedArtifacts.forEach(artifact => {
                    artifacts.set(artifact.id, artifact);
                });

                console.log('All artifacts after adding:', Array.from(artifacts.entries())); // Debug log

                // Parse Markdown (this will convert code blocks to HTML)
                processedContent = marked.parse(result.content);

                // Find and replace artifact markers in the parsed HTML
                const markerRegex = /<!-- ARTIFACT:(.*?) -->/g;
                processedContent = processedContent.replace(markerRegex, (match, artifactId) => {
                    const artifact = artifacts.get(artifactId);
                    if (artifact) {
                        return `<div class="artifact-placeholder" data-artifact-id="${artifactId}">
                            <span class="artifact-placeholder-icon">${getTypeIcon(artifact.type)}</span>
                            <div class="artifact-placeholder-text">
                                <div class="artifact-placeholder-label">Artifact</div>
                                <div class="artifact-placeholder-title">${artifact.title}</div>
                            </div>
                            <span class="artifact-placeholder-arrow">‚Üí</span>
                        </div>`;
                    }
                    return match;
                });

                // Update artifacts display
                if (isArtifactsOpen) {
                    updateArtifactsDisplay();
                }
            } else {
                // Escape HTML for user messages
                processedContent = escapeHtml(content);
            }

            const messageContentDiv = document.createElement('div');
            messageContentDiv.className = 'message-content';

            if (role === 'assistant') {
                const copyBtn = document.createElement('div');
                copyBtn.className = 'copy-btn';
                copyBtn.innerHTML = '&#x1f4cb; <span>Copy</span>';
                copyBtn.setAttribute('data-raw-content', content);
                copyBtn.onclick = (e) => copyToClipboard(e);

                const footer = document.createElement('div');
                footer.className = 'message-footer';

                const timeDiv = document.createElement('div');
                timeDiv.className = 'message-time';
                timeDiv.textContent = time;

                footer.appendChild(timeDiv);
                footer.appendChild(copyBtn);

                messageContentDiv.innerHTML = processedContent;
                messageContentDiv.appendChild(footer);

            } else {
                messageContentDiv.innerHTML = `
                    ${processedContent}
                    <div class="message-time">${time}</div>
                `;
            }

            messageDiv.appendChild(messageContentDiv);
            messagesDiv.appendChild(messageDiv);

            // Add click handler for artifact placeholders
            const placeholders = messageDiv.querySelectorAll('.artifact-placeholder');
            placeholders.forEach(placeholder => {
                // Add click handler
                placeholder.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const artifactId = this.getAttribute('data-artifact-id');
                    console.log('Artifact clicked:', artifactId); // Debug log
                    openArtifactsModal();
                    showArtifact(artifactId);
                });
            });

            // Process MathJax, Mermaid, and Highlight.js
            if (role === 'assistant') {
                await MathJax.typesetPromise([messageDiv]);

                // Process Mermaid code blocks
                const mermaidCodeBlocks = messageDiv.querySelectorAll('pre code.language-mermaid');
                for (const codeBlock of mermaidCodeBlocks) {
                    const code = codeBlock.textContent;
                    const mermaidDiv = document.createElement('div');
                    mermaidDiv.className = 'mermaid';
                    mermaidDiv.textContent = code;
                    codeBlock.parentNode.replaceWith(mermaidDiv);
                }

                try {
                    await mermaid.run({
                        nodes: messageDiv.querySelectorAll('.mermaid')
                    });
                } catch(e) {
                    console.error("Mermaid rendering error:", e);
                }

                // Highlight code blocks (excluding mermaid which has been replaced)
                messageDiv.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            }

            scrollToBottom();
        }

        function copyToClipboard(event) {
            const button = event.currentTarget;
            const rawContent = button.getAttribute('data-raw-content');
            navigator.clipboard.writeText(rawContent).then(() => {
                const originalText = button.innerHTML;
                button.innerHTML = '‚úì Copied!';
                button.style.color = '#27ae60'; // Green color for success
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.color = ''; // Revert color
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
            });
            event.stopPropagation();
        }

        function addErrorMessage(message) {
            const messagesDiv = document.getElementById('messages');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            messagesDiv.appendChild(errorDiv);
            scrollToBottom();
        }

        async function deleteSession(sessionId, event) {
            event.stopPropagation();
            if (!confirm('Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§Ê≠§‰ºöËØùÂêóÔºü')) return;

            try {
                await fetch(`/api/sessions/${sessionId}`, { method: 'DELETE' });

                if (sessionId === currentSessionId) {
                    currentSessionId = null;
                    document.getElementById('messages').innerHTML = '<div class="welcome"><h2>üëã Ê¨¢Ëøé!</h2><p>ÂàõÂª∫‰∏Ä‰∏™Êñ∞‰ºöËØùÊàñÈÄâÊã©Áé∞Êúâ‰ºöËØùÂºÄÂßãËÅäÂ§©„ÄÇ</p></div>';
                    document.getElementById('message-input').disabled = true;
                    document.getElementById('send-btn').disabled = true;
                    document.getElementById('status').textContent = 'ÈÄâÊã©ÊàñÂàõÂª∫‰∏Ä‰∏™‰ºöËØù';

                    // Clear artifacts if we're deleting the current session
                    clearArtifacts();
                }
                loadSessions();
            } catch (error) {
                console.error('Failed to delete session:', error);
                alert('Failed to delete session');
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebarCollapsed = !sidebarCollapsed;

            if (sidebarCollapsed) {
                sidebar.classList.add('collapsed');
            } else {
                sidebar.classList.remove('collapsed');
            }
        }

        function scrollToBottom() {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            return date.toLocaleDateString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        // Artifacts Functions
        function extractArtifacts(content) {
            const artifacts = [];
            let processedContent = content;

            // Types that should be extracted as artifacts
            const artifactTypes = ['html', 'svg', 'python', 'javascript', 'js', 'shell', 'bash', 'sh',
                                  'css', 'json', 'yaml', 'yml', 'sql', 'docker', 'dockerfile',
                                  'go', 'java', 'cpp', 'c', 'rust', 'typescript', 'ts',
                                  'php', 'ruby', 'swift', 'kotlin', 'markdown', 'md'];

            // Extract code blocks using regex pattern
            // Format: ```language ... ```
            const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;

            let match;
            let artifactIndex = 0;

            while ((match = codeBlockRegex.exec(content)) !== null) {
                const language = match[1] || 'text';
                const codeContent = match[2].trim();

                // Check if this type should be extracted as artifact
                if (artifactTypes.includes(language.toLowerCase())) {
                    const artifactId = `artifact_${Date.now()}_${artifactIndex++}`;
                    const type = language.toLowerCase();

                    // Generate a smart title based on content
                    let title = generateArtifactTitle(codeContent, type);

                    artifacts.push({
                        id: artifactId,
                        type: type,
                        language: language,
                        title: title,
                        content: codeContent
                    });

                    // Replace code block with placeholder marker
                    processedContent = processedContent.replace(match[0],
                        `<!-- ARTIFACT:${artifactId} -->`);
                }
            }

            return {
                content: processedContent,
                artifacts: artifacts
            };
        }

        function generateArtifactTitle(content, type) {
            // Try to extract a meaningful title from the content
            const lines = content.split('\n').filter(line => line.trim());

            // For HTML, look for title tag
            if (type === 'html') {
                const titleMatch = content.match(/<title>(.*?)<\/title>/i);
                if (titleMatch) return titleMatch[1];
            }

            // For Python/JavaScript/Java, look for function/class/variable definitions
            if (['python', 'javascript', 'js', 'java', 'go', 'rust', 'typescript', 'ts'].includes(type)) {
                const funcMatch = lines.find(line =>
                    line.match(/^(def|function|func|fn)\s+\w+/) ||
                    line.match(/^class\s+\w+/) ||
                    line.match(/^(const|let|var)\s+\w+/)
                );
                if (funcMatch) return funcMatch.trim().split(/\s+/)[1];
            }

            // For shell/bash, look for shebang or first command
            if (['shell', 'bash', 'sh'].includes(type)) {
                if (lines[0] && lines[0].startsWith('#!')) {
                    return lines[0].substring(2).trim();
                }
            }

            // For CSS, look for class or ID selectors
            if (type === 'css') {
                const selectorMatch = lines.find(line =>
                    line.match(/^\.[\w-]+\s*\{/) ||
                    line.match(/^#[\w-]+\s*\{/)
                );
                if (selectorMatch) return selectorMatch.trim().split(/\s+/)[0];
            }

            // For Dockerfile
            if (type === 'dockerfile' || type === 'docker') {
                const fromMatch = lines.find(line => line.startsWith('FROM'));
                if (fromMatch) return `Dockerfile - ${fromMatch}`;
            }

            // Default: use first line or type name
            if (lines.length > 0 && lines[0].length < 50) {
                return lines[0].substring(0, 30);
            }

            return `${type.charAt(0).toUpperCase() + type.slice(1)} Code`;
        }

        let isArtifactsOpen = false;

        function clearArtifacts() {
            console.log('Clearing artifacts...'); // Debug log

            // Clear current artifacts
            artifacts.clear();
            currentArtifactId = null;

            // Update display
            updateArtifactsDisplay();

            // Close sidebar
            if (isArtifactsOpen) {
                const artifactsSidebar = document.getElementById('artifacts-sidebar');
                artifactsSidebar.classList.add('collapsed');
                isArtifactsOpen = false;
            }
        }

        
        function toggleArtifactsSidebar() {
            const artifactsSidebar = document.getElementById('artifacts-sidebar');

            console.log('Toggling artifacts sidebar, current artifacts count:', artifacts.size); // Debug log

            isArtifactsOpen = !isArtifactsOpen;

            if (isArtifactsOpen) {
                artifactsSidebar.classList.remove('collapsed');
                updateArtifactsDisplay();
            } else {
                artifactsSidebar.classList.add('collapsed');
            }
        }

        function updateArtifactsDisplay() {
            const titleElement = document.getElementById('artifacts-title');
            const headerElement = document.getElementById('artifacts-header');
            const contentContainer = document.getElementById('artifacts-content');

            if (artifacts.size === 0) {
                headerElement.innerHTML = '<h2 id="artifacts-title">Artifacts</h2>';
                contentContainer.innerHTML = '<div class="no-artifacts">No artifacts in this session</div>';
                currentArtifactId = null;
                return;
            }

            // If there's a current artifact, update the header to show its info
            if (currentArtifactId && artifacts.has(currentArtifactId)) {
                const artifact = artifacts.get(currentArtifactId);
                const icon = getTypeIcon(artifact.type);
                headerElement.innerHTML = `<h2 id="artifacts-title">${icon} ${artifact.title}</h2>`;
            } else {
                // Show first artifact if none selected
                const firstArtifactId = artifacts.keys().next().value;
                if (firstArtifactId) {
                    showArtifact(firstArtifactId);
                }
            }
        }

        function openArtifactsModal() {
            if (!isArtifactsOpen) {
                toggleArtifactsSidebar();
            }
        }

        function closeArtifactsModal() {
            if (isArtifactsOpen) {
                toggleArtifactsSidebar();
            }
        }

        function showArtifact(artifactId) {
            const artifact = artifacts.get(artifactId);
            if (!artifact) {
                return;
            }

            // Update current artifact ID
            currentArtifactId = artifactId;

            // Ensure artifacts sidebar is open
            if (!isArtifactsOpen) {
                const artifactsSidebar = document.getElementById('artifacts-sidebar');
                artifactsSidebar.classList.remove('collapsed');
                isArtifactsOpen = true;
            }

            // Update header with current artifact info
            const headerElement = document.getElementById('artifacts-header');
            const icon = getTypeIcon(artifact.type);
            headerElement.innerHTML = `<h2 id="artifacts-title">${icon} ${artifact.title}</h2>`;

            // Show artifact content
            const content = document.getElementById('artifacts-content');
            content.innerHTML = '<div class="artifact-full">' + renderArtifactContent(artifact) + '</div>';
        }

        function getTypeIcon(type) {
            const icons = {
                'html': 'üåê',
                'svg': 'üé®',
                'python': 'üêç',
                'javascript': '‚ö°',
                'shell': 'üñ•Ô∏è',
                'bash': 'üñ•Ô∏è',
                'markdown': 'üìù',
                'json': 'üìã',
                'yaml': 'üìã',
                'css': 'üé®',
                'sql': 'üóÑÔ∏è',
                'docker': 'üê≥',
                'kubernetes': '‚ò∏Ô∏è',
                'terraform': 'üèóÔ∏è',
                'go': 'üêπ',
                'java': '‚òï',
                'cpp': '‚öôÔ∏è',
                'c': '‚öôÔ∏è',
                'rust': 'ü¶Ä',
                'typescript': 'üìò',
                'php': 'üêò',
                'ruby': 'üíé',
                'swift': 'üçé',
                'kotlin': 'üéØ'
            };
            return icons[type] || 'üìÑ';
        }

        function renderArtifactContent(artifact) {
            const { type, content, language } = artifact;

            switch (type) {
                case 'html':
                    return `<iframe srcdoc="${escapeHtml(content)}"></iframe>`;

                case 'svg':
                    return content;

                case 'python':
                case 'javascript':
                case 'js':
                case 'shell':
                case 'bash':
                case 'sh':
                case 'markdown':
                case 'md':
                case 'json':
                case 'yaml':
                case 'yml':
                case 'css':
                case 'sql':
                case 'docker':
                case 'dockerfile':
                case 'go':
                case 'java':
                case 'cpp':
                case 'c':
                case 'rust':
                case 'typescript':
                case 'ts':
                case 'php':
                case 'ruby':
                case 'swift':
                case 'kotlin':
                case 'text':
                default:
                    // Map types to highlight.js languages
                    const langMap = {
                        'js': 'javascript',
                        'ts': 'typescript',
                        'sh': 'bash',
                        'dockerfile': 'dockerfile',
                        'md': 'markdown',
                        'yml': 'yaml'
                    };
                    const hlLang = langMap[type] || language || type;

                    // Try to highlight, fallback to plaintext if language not supported
                    let highlighted;
                    try {
                        highlighted = hljs.highlight(content, { language: hlLang }).value;
                    } catch (e) {
                        highlighted = hljs.highlight(content, { language: 'plaintext' }).value;
                    }
                    return `<pre><code>${highlighted}</code></pre>`;
            }
        }

  
      
        </script>
</body>

</html>