# Mental Loop (模拟器循环) 示例

本示例演示了 **Mental Loop** 架构模式，该模式让智能体在真实执行前，通过在安全的模拟环境中测试提议的行动来实现"三思而后行"。

## 架构模式

Mental Loop 模式实现了一个深思熟虑的决策过程：

```
┌─────────────────────────────────────────────────────┐
│                   MENTAL LOOP                       │
│                    心智循环                          │
│                                                     │
│  ┌──────────┐   ┌───────────┐   ┌──────────────┐ │
│  │   观察   │──▶│   提议    │──▶│    模拟      │ │
│  │  市场    │   │  策略     │   │    结果      │ │
│  └──────────┘   └───────────┘   └──────┬───────┘ │
│                                         │         │
│  ┌──────────┐   ┌───────────┐          │         │
│  │   执行   │◀──│   优化    │◀─────────┘         │
│  │  行动    │   │  决策     │                     │
│  └──────────┘   └───────────┘                     │
└─────────────────────────────────────────────────────┘
```

## 核心组件

### 1. **分析师节点** (观察者 & 提议者)
- 观察当前市场状况
- 提出高层级交易策略（买入/卖出/持有）
- 基于市场趋势和新闻提供推理依据

### 2. **模拟器节点** (沙箱环境)
- 创建市场状态的深度副本
- 运行多次模拟（蒙特卡洛方法）
- 在不同场景下测试提议的策略
- 生成统计结果（最好/最坏/平均情况）

### 3. **风险管理器节点** (评估者 & 优化者)
- 分析模拟结果
- 评估风险/回报比率
- 优化或调整提议的策略
- 综合考虑风险因素做出最终决策

### 4. **执行节点** (真实世界行动)
- 将最终决策应用于实际环境
- 报告即时影响
- 触发下一个观察周期

## 股票交易场景

本示例模拟了一个股票交易智能体，它会：

1. **观察** 每日市场状况（价格、趋势、新闻）
2. **提议** 通过 AI 分析师提出交易行动
3. **模拟** 在 10 天周期内运行 5 个场景的结果
4. **评估** 统计结果（平均/最小/最大 盈亏）
5. **优化** 通过 AI 风险管理器调整策略
6. **执行** 在真实市场中执行最终决策

### 市场模拟器

市场模拟器提供：
- 基于趋势的价格变动（牛市/熊市/中性）
- 波动率建模
- 投资组合跟踪（股票 + 现金）
- 事件驱动的场景（财报、竞争、等）

## 工作流程

```go
workflow := graph.NewStateGraph()

// 按顺序添加节点
workflow.AddNode("analyst", "analyst", AnalystNode)
workflow.AddNode("simulator", "simulator", SimulatorNode)
workflow.AddNode("risk_manager", "risk_manager", RiskManagerNode)
workflow.AddNode("execute", "execute", ExecuteNode)

// 定义心智循环流程
workflow.AddEdge("analyst", "simulator")
workflow.AddEdge("simulator", "risk_manager")
workflow.AddEdge("risk_manager", "execute")
```

## 关键特性

### 安全探索
策略在沙箱环境的副本中测试，不会产生真实世界的后果。

### 统计分析
多次模拟运行提供置信区间和风险指标。

### 自适应决策
风险管理器可以根据模拟结果修改提议（例如，如果方差过高则减少仓位）。

### 审计跟踪
从观察 → 提议 → 模拟 → 决策的完整推理链。

## 示例输出

```
=== 第 1 天 - MENTAL LOOP 循环 ===

📊 分析师提议:
Action: buy 40 shares
Reasoning: 市场当前处于牛市，正面财报进一步增强信心...

🔬 运行模拟:
  模拟 1: 最终价值: $11067.91 (盈亏: $1067.91)
  模拟 2: 最终价值: $10928.86 (盈亏: $928.86)
  模拟 3: 最终价值: $10936.00 (盈亏: $936.00)
  模拟 4: 最终价值: $11074.61 (盈亏: $1074.61)
  模拟 5: 最终价值: $11146.31 (盈亏: $1146.31)

⚖️  风险管理器决策:
Decision: buy 30 shares
Reasoning: 基于显示正期望值的模拟结果（平均 $1030.74），
我批准交易但将仓位减少到 30 股以平衡机会和下行风险。

模拟统计 - 平均盈亏: $1030.74, 范围: [$928.86, $1146.31]

💼 在真实市场执行:
执行前: 第1天 | 价格: $100.00 | 投资组合: $10000.00
执行后: 第2天 | 价格: $101.99 | 股票: 30 | 投资组合: $10059.62
即时影响: $59.62
```

## 优势

✅ **风险缓解**: 在投入真实资源前测试策略
✅ **概率推理**: 理解可能结果的范围
✅ **可解释决策**: 每个步骤都有清晰的推理
✅ **自适应行为**: 基于模拟结果调整策略

## 局限性

⚠️ **模拟保真度**: 有效性取决于模拟器的准确性
⚠️ **计算成本**: 多次模拟会增加延迟
⚠️ **模型假设**: 真实世界可能与模拟场景不同

## 何时使用

此模式适用于：
- 行动具有重大后果（金融、安全关键型）
- 拥有可靠的模拟环境
- 可以接受决策延迟（非实时）
- 需要可解释、可审计的决策

## 运行示例

```bash
cd examples/mental_loop
go run main.go
```

确保已设置 OpenAI API 密钥：
```bash
export OPENAI_API_KEY="your-api-key"
```

## 与其他模式的比较

| 模式 | 描述 | 何时使用 |
|---------|-------------|-------------|
| **ReAct** | 实时推理 + 行动 | 快速、低风险决策 |
| **Planning** | 创建计划，然后执行 | 多步骤任务 |
| **Reflection** | 行动后批判 | 质量改进 |
| **Mental Loop** | 模拟后再行动 | 高风险决策 |

## 实现细节

### 市场状态结构

```go
type MarketState struct {
    Price       float64  // 当前股价
    Trend       string   // "bullish", "bearish", "neutral"
    NewsEvent   string   // 新闻事件
    DayNumber   int      // 交易日
    Shares      int      // 持有股票数
    Cash        float64  // 现金余额
}
```

### 智能体状态结构

```go
type AgentState struct {
    RealMarket        *MarketState        // 真实市场状态
    ProposedAction    string              // 提议的行动
    ProposedAmount    int                 // 提议的数量
    SimulationResults []SimulationResult  // 模拟结果集
    FinalDecision     string              // 最终决策
    FinalAmount       int                 // 最终数量
    Reasoning         string              // 推理过程
}
```

### 心智循环流程

1. **分析师节点**: 使用 LLM 分析市场并提出策略
2. **模拟器节点**: 运行 5 次独立模拟，每次预测 10 天
3. **风险管理器节点**: 使用 LLM 评估模拟结果并调整策略
4. **执行节点**: 在真实市场中应用最终决策

### 模拟方法

```go
// 创建市场状态的深度副本
simMarket := state.RealMarket.Copy()

// 执行提议的行动
simMarket.Step(proposedAction, proposedAmount)

// 向前运行 10 天
for day := 0; day < 10; day++ {
    simMarket.Step("hold", 0)
}

// 计算最终价值和盈亏
finalValue := simMarket.Cash + float64(simMarket.Shares) * simMarket.Price
profitLoss := finalValue - initialValue
```

## 关键设计原则

### 1. 状态隔离
模拟使用深度副本，确保不会污染真实状态：
```go
func (m *MarketState) Copy() *MarketState {
    return &MarketState{
        Price:      m.Price,
        Trend:      m.Trend,
        // ... 复制所有字段
    }
}
```

### 2. 蒙特卡洛方法
运行多次模拟以捕获不确定性：
- 每次模拟都有随机的价格变动
- 汇总结果提供统计置信度
- 揭示最好和最坏情况场景

### 3. 两阶段 LLM 决策
- **第一阶段（分析师）**: 基于观察提出策略
- **第二阶段（风险管理器）**: 基于证据（模拟结果）优化策略

### 4. 渐进式优化
风险管理器可以：
- 批准原始提议
- 减少仓位规模（例如从 50 股降到 20 股）
- 完全拒绝并选择持有

## 扩展可能性

### 1. 更复杂的模拟器
- 添加市场微观结构（买卖差价、滑点）
- 模拟多个相关资产
- 包含交易成本和税收

### 2. 高级风险指标
- 计算夏普比率
- 跟踪最大回撤
- 评估风险价值（VaR）

### 3. 多代理协作
- 多个分析师提供不同观点
- 集成技术和基本面分析
- 市场情绪分析

### 4. 自适应模拟
- 根据历史准确度调整模拟参数
- 学习更好的价格变动模型
- 动态调整模拟数量和周期

## 实战经验

### 成功案例

✅ **第 1 天**: 分析师建议买入 40 股，模拟显示平均盈利 $1030。风险管理器批准但减少到 30 股以管理风险。结果：盈利 $59.62

✅ **风险控制**: 在第 2 天，尽管模拟显示负期望值，风险管理器仍将仓位从 20 股减少到 10 股，有效限制了损失

### 挑战

⚠️ **第 2 天**: 市场转为熊市，模拟显示平均损失 $1026。代理仍然买入但减少仓位，最终亏损 $88.40。这展示了即使有模拟，市场的不可预测性仍然存在。

⚠️ **解析问题**: LLM 响应格式可能不一致，需要健壮的解析逻辑来处理 "ACTION:" 和 "DECISION:" 等不同关键词。

## 与原始论文的对比

本实现基于 [Fareed Khan 的 Agentic Architectures](https://github.com/FareedKhan-dev/all-agentic-architectures/blob/main/10_mental_loop.ipynb) 中的 Mental Loop 模式，但进行了以下改进：

1. **使用 Go 语言实现**: 而非 Python，提供更好的性能和并发支持
2. **集成 LangGraphGo**: 利用成熟的图执行框架
3. **健壮的解析**: 处理 LLM 输出的多种格式
4. **详细的日志**: 每个步骤都有清晰的可视化输出

## 进一步阅读

- 原始概念: [基于模拟器的强化学习](https://arxiv.org/abs/2002.04898)
- AI 中的心智模型: [世界模型](https://arxiv.org/abs/1803.10122)
- 代理架构: [智能体架构模式](https://github.com/FareedKhan-dev/all-agentic-architectures)

## 许可证

本示例是 LangGraphGo 项目的一部分。
